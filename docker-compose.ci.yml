version: '3.8'

services:
  postgresql:
    image: docker.io/sameersbn/postgresql:12-20200524
    container_name: gitlab-postgresql
    environment:
      - DB_NAME=gitlabhq_production
      - DB_USER=gitlab
      - DB_PASS=password
      - DB_EXTENSION=pg_trgm,btree_gist
    volumes:
      - gitlab-postgresql-data:/var/lib/postgresql
    networks:
      - cicd
    restart: always

  redis:
    image: docker.io/redis:7.4-alpine
    container_name: gitlab-redis
    command: redis-server --appendonly yes
    volumes:
      - gitlab-redis-data:/data
    networks:
      - cicd
    restart: always

  gitlab:
    image: docker.io/sameersbn/gitlab:18.2.1
    container_name: gitlab-ce
    depends_on:
      - redis
      - postgresql
    ports:
      - "8086:80"      # SAFE: Avoids LVDA on 8080
      - "2222:22"      # SSH Git operations
    networks:
      - cicd
    environment:
      - DEBUG=false
      
      - DB_ADAPTER=postgresql
      - DB_HOST=postgresql
      - DB_PORT=5432
      - DB_NAME=gitlabhq_production
      - DB_USER=gitlab
      - DB_PASS=password
      
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      
      - TZ=Europe/Paris
      - GITLAB_TIMEZONE=Paris
      
      - GITLAB_HTTPS=false
      - SSL_SELF_SIGNED=false
      
      - GITLAB_HOST=192.168.1.74
      - GITLAB_PORT=8086
      - GITLAB_SSH_PORT=2222
      
      - GITLAB_SECRETS_DB_KEY_BASE=long-and-random-alphanumeric-string-db
      - GITLAB_SECRETS_SECRET_KEY_BASE=long-and-random-alphanumeric-string-secret
      - GITLAB_SECRETS_OTP_KEY_BASE=long-and-random-alphanumeric-string-otp
      
      - GITLAB_ROOT_PASSWORD=initialpassword123
      - GITLAB_ROOT_EMAIL=admin@example.com
      
      - GITLAB_NOTIFY_ON_BROKEN_BUILDS=true
      - GITLAB_NOTIFY_PUSHER=false
      
      - GITLAB_EMAIL=admin@example.com
      - GITLAB_EMAIL_REPLY_TO=noreply@example.com
      - GITLAB_INCOMING_EMAIL_ADDRESS=reply@example.com
      
      - GITLAB_BACKUP_SCHEDULE=daily
      - GITLAB_BACKUP_TIME=01:00
      
    volumes:
      - gitlab-data:/home/git/data
    restart: always

  gitlab-runner:
    image: docker.io/gitlab/gitlab-runner:latest
    container_name: gitlab-runner-1
    networks:
      - cicd
    volumes:
      - gitlab-runner-config:/etc/gitlab-runner
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
    restart: always
    depends_on:
      - gitlab

volumes:
  gitlab-postgresql-data:
    driver: local
  gitlab-redis-data:
    driver: local
  gitlab-data:
    driver: local
  gitlab-runner-config:
    driver: local

networks:
  cicd:
    name: gitlab-cicd
    driver: bridge